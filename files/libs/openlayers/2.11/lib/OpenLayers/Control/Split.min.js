OpenLayers.Control.Split=OpenLayers.Class(OpenLayers.Control,{EVENT_TYPES:["beforesplit","split","aftersplit"],layer:null,source:null,sourceOptions:null,tolerance:null,edge:!0,deferDelete:!1,mutual:!0,targetFilter:null,sourceFilter:null,handler:null,initialize:function(e){Array.prototype.push.apply(this.EVENT_TYPES,OpenLayers.Control.prototype.EVENT_TYPES),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.options=e||{},this.options.source&&this.setSource(this.options.source)},setSource:function(e){this.active?(this.deactivate(),this.handler&&(this.handler.destroy(),delete this.handler),this.source=e,this.activate()):this.source=e},activate:function(){var e=OpenLayers.Control.prototype.activate.call(this);return e&&(this.source?this.source.events&&this.source.events.on({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}):(this.handler||(this.handler=new OpenLayers.Handler.Path(this,{done:function(e){this.onSketchComplete({feature:new OpenLayers.Feature.Vector(e)})}},{layerOptions:this.sourceOptions})),this.handler.activate())),e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.call(this);return e&&this.source&&this.source.events&&this.layer.events.un({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}),e},onSketchComplete:function(e){return this.feature=null,!this.considerSplit(e.feature)},afterFeatureModified:function(e){if(e.modified){var t=e.feature;(t.geometry instanceof OpenLayers.Geometry.LineString||t.geometry instanceof OpenLayers.Geometry.MultiLineString)&&(this.feature=e.feature,this.considerSplit(e.feature))}},removeByGeometry:function(e,t){for(var i=0,n=e.length;n>i;++i)if(e[i].geometry===t){e.splice(i,1);break}},isEligible:function(e){return e.state!==OpenLayers.State.DELETE&&(e.geometry instanceof OpenLayers.Geometry.LineString||e.geometry instanceof OpenLayers.Geometry.MultiLineString)&&this.feature!==e&&(!this.targetFilter||this.targetFilter.evaluate(e.attributes))},considerSplit:function(e){var t=!1,i=!1;if(!this.sourceFilter||this.sourceFilter.evaluate(e.attributes)){for(var n,r,o,s,a,l,c,h=this.layer&&this.layer.features||[],u=[],d=[],p=this.layer===this.source&&this.mutual,f={edge:this.edge,tolerance:this.tolerance,mutual:p},m=[e.geometry],g=0,v=h.length;v>g;++g)if(s=h[g],this.isEligible(s)){a=[s.geometry];for(var y=0;m.length>y;++y){l=m[y];for(var b=0;a.length>b;++b)n=a[b],l.getBounds().intersectsBounds(n.getBounds())&&(r=l.split(n,f),r&&(o=this.events.triggerEvent("beforesplit",{source:e,target:s}),o!==!1&&(p&&(c=r[0],c.length>1&&(c.unshift(y,1),Array.prototype.splice.apply(m,c),y+=c.length-3),r=r[1]),r.length>1&&(r.unshift(b,1),Array.prototype.splice.apply(a,r),b+=r.length-3))))}a&&a.length>1&&(this.geomsToFeatures(s,a),this.events.triggerEvent("split",{original:s,features:a}),Array.prototype.push.apply(u,a),d.push(s),i=!0)}if(m&&m.length>1&&(this.geomsToFeatures(e,m),this.events.triggerEvent("split",{original:e,features:m}),Array.prototype.push.apply(u,m),d.push(e),t=!0),t||i){if(this.deferDelete){for(var x,C=[],g=0,v=d.length;v>g;++g)x=d[g],x.state===OpenLayers.State.INSERT?C.push(x):(x.state=OpenLayers.State.DELETE,this.layer.drawFeature(x));this.layer.destroyFeatures(C,{silent:!0});for(var g=0,v=u.length;v>g;++g)u[g].state=OpenLayers.State.INSERT}else this.layer.destroyFeatures(d,{silent:!0});this.layer.addFeatures(u,{silent:!0}),this.events.triggerEvent("aftersplit",{source:e,features:u})}}return t},geomsToFeatures:function(e,t){var i=e.clone();delete i.geometry;for(var n,r=0,o=t.length;o>r;++r)n=i.clone(),n.geometry=t[r],n.state=OpenLayers.State.INSERT,t[r]=n},destroy:function(){this.active&&this.deactivate(),OpenLayers.Control.prototype.destroy.call(this)},CLASS_NAME:"OpenLayers.Control.Split"});