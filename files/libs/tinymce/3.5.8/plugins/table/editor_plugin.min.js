(function(e){function t(e,t){var i,n=t.ownerDocument,r=n.createRange();return r.setStartBefore(t),r.setEnd(e.endContainer,e.endOffset),i=n.createElement("body"),i.appendChild(r.cloneContents()),0==i.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length}function n(e,t){return parseInt(e.getAttribute(t)||1)}function r(t,r,o){function a(e,t){return e=e.cloneNode(t),e.removeAttribute("id"),e}function l(){var e=0;M=[],s(["thead","tbody","tfoot"],function(i){var o=r.select("> "+i+" tr",t);s(o,function(t,o){o+=e,s(r.select("> td, > th",t),function(e,t){var r,s,a,l;if(M[o])for(;M[o][t];)t++;for(a=n(e,"rowspan"),l=n(e,"colspan"),s=o;o+a>s;s++)for(M[s]||(M[s]=[]),r=t;t+l>r;r++)M[s][r]={part:i,real:s==o&&r==t,elm:e,rowspan:a,colspan:l}})}),e+=o.length})}function c(e,t){var i;return i=M[t],i?i[e]:void 0}function h(e,t,i){e&&(i=parseInt(i),1===i?e.removeAttribute(t,1):e.setAttribute(t,i,1))}function u(e){return e&&(r.hasClass(e.elm,"mceSelected")||e==D)}function d(){var e=[];return s(t.rows,function(t){s(t.cells,function(i){return r.hasClass(i,"mceSelected")||i==D.elm?(e.push(t),!1):void 0})}),e}function p(){var e=r.createRng();e.setStartAfter(t),e.setEndAfter(t),o.setRng(e),r.remove(t)}function f(t){var i;return e.walk(t,function(n){var o;return 3==n.nodeType?(s(r.getParents(n.parentNode,null,t).reverse(),function(e){e=a(e,!1),i?o&&o.appendChild(e):i=o=e,o=e}),o&&(o.innerHTML=e.isIE?"&nbsp;":'<br data-mce-bogus="1" />'),!1):void 0},"childNodes"),t=a(t,!1),h(t,"rowSpan",1),h(t,"colSpan",1),i?t.appendChild(i):e.isIE||(t.innerHTML='<br data-mce-bogus="1" />'),t}function m(){var e=r.createRng();return s(r.select("tr",t),function(e){0==e.cells.length&&r.remove(e)}),0==r.select("tr",t).length?(e.setStartAfter(t),e.setEndAfter(t),o.setRng(e),r.remove(t),void 0):(s(r.select("thead,tbody,tfoot",t),function(e){0==e.rows.length&&r.remove(e)}),l(),row=M[Math.min(M.length-1,N.y)],row&&(o.select(row[Math.min(row.length-1,N.x)].elm,!0),o.collapse(!0)),void 0)}function g(e,t,i,n){var s,o,a,l,c;for(s=M[t][e].elm.parentNode,a=1;i>=a;a++)if(s=r.getNext(s,"tr")){for(o=e;o>=0;o--)if(c=M[t+a][o].elm,c.parentNode==s){for(l=1;n>=l;l++)r.insertAfter(f(c),c);break}if(-1==o)for(l=1;n>=l;l++)s.insertBefore(f(s.cells[0]),s.cells[0])}}function v(){s(M,function(e,t){s(e,function(e,i){var s,o,a;if(u(e)&&(e=e.elm,s=n(e,"colspan"),o=n(e,"rowspan"),s>1||o>1)){for(h(e,"rowSpan",1),h(e,"colSpan",1),a=0;s-1>a;a++)r.insertAfter(f(e),e);g(i,t,o-1,s)}})})}function b(t,i,n){var o,a,d,p,f,g,y,b,t,x,L;if(t?(pos=T(t),o=pos.x,a=pos.y,d=o+(i-1),p=a+(n-1)):(N=R=null,s(M,function(e,t){s(e,function(e,i){u(e)&&(N||(N={x:i,y:t}),R={x:i,y:t})})}),o=N.x,a=N.y,d=R.x,p=R.y),y=c(o,a),b=c(d,p),y&&b&&y.part==b.part){for(v(),l(),y=c(o,a).elm,h(y,"colSpan",d-o+1),h(y,"rowSpan",p-a+1),g=a;p>=g;g++)for(f=o;d>=f;f++)M[g]&&M[g][f]&&(t=M[g][f].elm,t!=y&&(x=e.grep(t.childNodes),s(x,function(e){y.appendChild(e)}),x.length&&(x=e.grep(y.childNodes),L=0,s(x,function(e){"BR"==e.nodeName&&r.getAttrib(e,"data-mce-bogus")&&L++<x.length-1&&y.removeChild(e)})),r.remove(t)));m()}}function L(e){var t,i,o,l,c,d,p,m,g;for(s(M,function(i,n){return s(i,function(i){return u(i)&&(i=i.elm,c=i.parentNode,d=a(c,!1),t=n,e)?!1:void 0}),e?!t:void 0}),l=0;M[0].length>l;l++)if(M[t][l]&&(i=M[t][l].elm,i!=o)){if(e){if(t>0&&M[t-1][l]&&(m=M[t-1][l].elm,g=n(m,"rowSpan"),g>1)){h(m,"rowSpan",g+1);continue}}else if(g=n(i,"rowspan"),g>1){h(i,"rowSpan",g+1);continue}p=f(i),h(p,"colSpan",i.colSpan),d.appendChild(p),o=i}d.hasChildNodes()&&(e?c.parentNode.insertBefore(d,c):r.insertAfter(d,c))}function w(e){var t,i;s(M,function(i){return s(i,function(i,n){return u(i)&&(t=n,e)?!1:void 0}),e?!t:void 0}),s(M,function(s,o){var a,l,c;s[t]&&(a=s[t].elm,a!=i&&(c=n(a,"colspan"),l=n(a,"rowspan"),1==c?e?(a.parentNode.insertBefore(f(a),a),g(t,o,l-1,c)):(r.insertAfter(f(a),a),g(t,o,l-1,c)):h(a,"colSpan",a.colSpan+1),i=a))})}function C(){var t=[];s(M,function(i){s(i,function(i,o){u(i)&&-1===e.inArray(t,o)&&(s(M,function(e){var t,i=e[o].elm;t=n(i,"colSpan"),t>1?h(i,"colSpan",t-1):r.remove(i)}),t.push(o))})}),m()}function S(){function e(e){var t,i,o;t=r.getNext(e,"tr"),s(e.cells,function(e){var t=n(e,"rowSpan");t>1&&(h(e,"rowSpan",t-1),i=T(e),g(i.x,i.y,1,1))}),i=T(e.cells[0]),s(M[i.y],function(e){var t;e=e.elm,e!=o&&(t=n(e,"rowSpan"),1>=t?r.remove(e):h(e,"rowSpan",t-1),o=e)})}var t;t=d(),s(t.reverse(),function(t){e(t)}),m()}function E(){var e=d();return r.remove(e),m(),e}function _(){var e=d();return s(e,function(t,i){e[i]=a(t,!0)}),e}function O(e,t){if(e){var n=d(),o=n[t?0:n.length-1],a=o.cells.length;s(M,function(e){var t;return a=0,s(e,function(e){e.real&&(a+=e.colspan),e.elm.parentNode==o&&(t=1)}),t?!1:void 0}),t||e.reverse(),s(e,function(e){var n,s=e.cells.length;for(i=0;s>i;i++)n=e.cells[i],h(n,"colSpan",1),h(n,"rowSpan",1);for(i=s;a>i;i++)e.appendChild(f(e.cells[s-1]));for(i=a;s>i;i++)r.remove(e.cells[i]);t?o.parentNode.insertBefore(e,o):r.insertAfter(e,o)}),r.removeClass(r.select("td.mceSelected,th.mceSelected"),"mceSelected")}}function T(e){var t;return s(M,function(i,n){return s(i,function(i,r){return i.elm==e?(t={x:r,y:n},!1):void 0}),!t}),t}function k(e){N=T(e)}function P(){var e,t;return e=t=0,s(M,function(i,n){s(i,function(i,r){var s,o;u(i)&&(i=M[n][r],r>e&&(e=r),n>t&&(t=n),i.real&&(s=i.colspan-1,o=i.rowspan-1,s&&r+s>e&&(e=r+s),o&&n+o>t&&(t=n+o)))})}),{x:e,y:t}}function A(e){var t,i,n,s,o,a,l,c;if(R=T(e),N&&R){for(t=Math.min(N.x,R.x),i=Math.min(N.y,R.y),n=Math.max(N.x,R.x),s=Math.max(N.y,R.y),o=n,a=s,y=i;a>=y;y++)e=M[y][t],e.real||t>t-(e.colspan-1)&&(t-=e.colspan-1);for(x=t;o>=x;x++)e=M[i][x],e.real||i>i-(e.rowspan-1)&&(i-=e.rowspan-1);for(y=i;s>=y;y++)for(x=t;n>=x;x++)e=M[y][x],e.real&&(l=e.colspan-1,c=e.rowspan-1,l&&x+l>o&&(o=x+l),c&&y+c>a&&(a=y+c));for(r.removeClass(r.select("td.mceSelected,th.mceSelected"),"mceSelected"),y=i;a>=y;y++)for(x=t;o>=x;x++)M[y][x]&&r.addClass(M[y][x].elm,"mceSelected")}}var M,N,R,D;l(),D=r.getParent(o.getStart(),"th,td"),D&&(N=T(D),R=P(),D=c(N.x,N.y)),e.extend(this,{deleteTable:p,split:v,merge:b,insertRow:L,insertCol:w,deleteCols:C,deleteRows:S,cutRows:E,copyRows:_,pasteRows:O,getPos:T,setStartCell:k,setEndCell:A})}var s=e.each;e.create("tinymce.plugins.TablePlugin",{init:function(i,o){function a(e){var t=i.selection,n=i.dom.getParent(e||t.getNode(),"table");return n?new r(n,i.dom,t):void 0}function l(){i.getBody().style.webkitUserSelect="",u&&(i.dom.removeClass(i.dom.select("td.mceSelected,th.mceSelected"),"mceSelected"),u=!1)}var c,h,u=!0;s([["table","table.desc","mceInsertTable",!0],["delete_table","table.del","mceTableDelete"],["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc","mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",!0],["cell_props","table.cell_desc","mceTableCellProps",!0],["split_cells","table.split_cells_desc","mceTableSplitCells",!0],["merge_cells","table.merge_cells_desc","mceTableMergeCells",!0]],function(e){i.addButton(e[0],{title:e[1],cmd:e[2],ui:e[3]})}),e.isIE||i.onClick.add(function(e,t){t=t.target,"TABLE"===t.nodeName&&(e.selection.select(t),e.nodeChanged())}),i.onPreProcess.add(function(e,t){var i,n,r,s,o=e.dom;for(i=o.select("table",t.node),n=i.length;n--;)r=i[n],o.setAttrib(r,"data-mce-style",""),(s=o.getAttrib(r,"width"))&&(o.setStyle(r,"width",s),o.setAttrib(r,"width","")),(s=o.getAttrib(r,"height"))&&(o.setStyle(r,"height",s),o.setAttrib(r,"height",""))}),i.onNodeChange.add(function(e,t,i){var n;i=e.selection.getStart(),n=e.dom.getParent(i,"td,th,caption"),t.setActive("table","TABLE"===i.nodeName||!!n),n&&"CAPTION"===n.nodeName&&(n=0),t.setDisabled("delete_table",!n),t.setDisabled("delete_col",!n),t.setDisabled("delete_table",!n),t.setDisabled("delete_row",!n),t.setDisabled("col_after",!n),t.setDisabled("col_before",!n),t.setDisabled("row_after",!n),t.setDisabled("row_before",!n),t.setDisabled("row_props",!n),t.setDisabled("cell_props",!n),t.setDisabled("split_cells",!n),t.setDisabled("merge_cells",!n)}),i.onInit.add(function(i){function r(e,t,i,n){var r,s,o,a=3,l=e.dom.getParent(t.startContainer,"TABLE");return l&&(r=l.parentNode),s=t.startContainer.nodeType==a&&0==t.startOffset&&0==t.endOffset&&n&&("TR"==i.nodeName||i==r),o=("TD"==i.nodeName||"TH"==i.nodeName)&&!n,s||o}function o(t){if(e.isWebKit){var i=t.selection.getRng(),n=t.selection.getNode(),s=t.dom.getParent(i.startContainer,"TD,TH");if(r(t,i,n,s)){s||(s=n);for(var o=s.lastChild;o.lastChild;)o=o.lastChild;i.setEnd(o,o.nodeValue.length),t.selection.setRng(i)}}}function d(t,i){function r(i,n,r){var s=i?"previousSibling":"nextSibling",a=t.dom.getParent(n,"tr"),h=a[s];if(h)return g(t,n,h,i),e.dom.Event.cancel(r),!0;var u=t.dom.getParent(a,"table"),d=a.parentNode,p=d.nodeName.toLowerCase();if("tbody"===p||p===(i?"tfoot":"thead")){var f=o(i,u,d,"tbody");if(null!==f)return l(i,f,n,r)}return c(i,a,s,u,r)}function o(e,i,n,r){var s=t.dom.select(">"+r,i),o=s.indexOf(n);if(e&&0===o||!e&&o===s.length-1)return a(e,i);if(-1===o){var l="thead"===n.tagName.toLowerCase()?0:s.length-1;return s[l]}return s[o+(e?-1:1)]}function a(e,i){var n=e?"thead":"tfoot",r=t.dom.select(">"+n,i);return 0!==r.length?r[0]:null}function l(i,n,r,s){var o=h(n,i);return o&&g(t,r,o,i),e.dom.Event.cancel(s),!0}function c(i,n,s,o,a){var l=o[s];if(l)return u(l),!0;var c=t.dom.getParent(o,"td,th");if(c)return r(i,c,a);var d=h(n,!i);return u(d),e.dom.Event.cancel(a)}function h(e,i){var n=e&&e[i?"lastChild":"firstChild"];return n&&"BR"===n.nodeName?t.dom.getParent(n,"td,th"):n}function u(e){t.selection.setCursorLocation(e,0)}function d(){return x==b.UP||x==b.DOWN}function p(e){var t=e.selection.getNode(),i=e.dom.getParent(t,"tr");return null!==i}function f(e){for(var t=0,i=e;i.previousSibling;)i=i.previousSibling,t+=n(i,"colspan");return t}function m(e,t){var i=0,r=0;return s(e.children,function(e,s){return i+=n(e,"colspan"),r=s,i>t?!1:void 0}),r}function g(e,t,i,n){var r=f(e.dom.getParent(t,"td,th")),s=m(i,r),o=i.childNodes[s],a=h(o,n);u(a||o)}function y(e){var i=t.selection.getNode(),n=t.dom.getParent(i,"td,th"),r=t.dom.getParent(e,"td,th");return n&&n!==r&&v(n,r)}function v(e,i){return t.dom.getParent(e,"TABLE")===t.dom.getParent(i,"TABLE")}var b=e.VK,x=i.keyCode;if(d()&&p(t)){var L=t.selection.getNode();setTimeout(function(){y(L)&&r(!i.shiftKey&&x===b.UP,L,i)},0)}}function p(){var t;for(t=i.getBody().lastChild;t&&3==t.nodeType&&!t.nodeValue.length;t=t.previousSibling);t&&"TABLE"==t.nodeName&&(i.settings.forced_root_block?i.dom.add(i.getBody(),i.settings.forced_root_block,null,e.isIE?"&nbsp;":'<br data-mce-bogus="1" />'):i.dom.add(i.getBody(),"br",{"data-mce-bogus":"1"}))}var f,m,g,y=i.dom;c=i.windowManager,i.onMouseDown.add(function(e,t){2!=t.button&&(l(),m=y.getParent(t.target,"td,th"),f=y.getParent(m,"table"))}),y.bind(i.getDoc(),"mouseover",function(e){var t,n,r=e.target;if(m&&(g||r!=m)&&("TD"==r.nodeName||"TH"==r.nodeName)){n=y.getParent(r,"table"),n==f&&(g||(g=a(n),g.setStartCell(m),i.getBody().style.webkitUserSelect="none"),g.setEndCell(r),u=!0),t=i.selection.getSel();try{t.removeAllRanges?t.removeAllRanges():t.empty()}catch(s){}e.preventDefault()}}),i.onMouseUp.add(function(t){function i(t,i){var r=new e.dom.TreeWalker(t,t);do{if(3==t.nodeType&&0!=e.trim(t.nodeValue).length)return i?n.setStart(t,0):n.setEnd(t,t.nodeValue.length),void 0;if("BR"==t.nodeName)return i?n.setStartBefore(t):n.setEndBefore(t),void 0}while(t=i?r.next():r.prev())}var n,r,s,o,a,l,c=t.selection;if(c.getSel(),m){if(g&&(t.getBody().style.webkitUserSelect=""),r=y.select("td.mceSelected,th.mceSelected"),r.length>0){n=y.createRng(),o=r[0],l=r[r.length-1],n.setStartBefore(o),n.setEndAfter(o),i(o,1),s=new e.dom.TreeWalker(o,y.getParent(r[0],"table"));do if("TD"==o.nodeName||"TH"==o.nodeName){if(!y.hasClass(o,"mceSelected"))break;a=o}while(o=s.next());i(a),c.setRng(n)}t.nodeChanged(),m=g=f=null}}),i.onKeyUp.add(function(){l()}),i.onKeyDown.add(function(e){o(e)}),i.onMouseDown.add(function(e,t){2!=t.button&&o(e)}),i.plugins.table.fixTableCellSelection=o,i&&i.plugins.contextmenu&&i.plugins.contextmenu.onContextMenu.add(function(e,t,n){var r,s=i.selection,o=s.getNode()||i.getBody();i.dom.getParent(n,"td")||i.dom.getParent(n,"th")||i.dom.select("td.mceSelected,th.mceSelected").length?(t.removeAll(),"A"!=o.nodeName||i.dom.getAttrib(o,"name")||(t.add({title:"advanced.link_desc",icon:"link",cmd:i.plugins.advlink?"mceAdvLink":"mceLink",ui:!0}),t.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"}),t.addSeparator()),"IMG"==o.nodeName&&-1==o.className.indexOf("mceItem")&&(t.add({title:"advanced.image_desc",icon:"image",cmd:i.plugins.advimage?"mceAdvImage":"mceImage",ui:!0}),t.addSeparator()),t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}}),t.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"}),t.add({title:"table.del",icon:"delete_table",cmd:"mceTableDelete"}),t.addSeparator(),r=t.addMenu({title:"table.cell"}),r.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"}),r.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"}),r.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"}),r=t.addMenu({title:"table.row"}),r.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"}),r.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"}),r.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"}),r.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"}),r.addSeparator(),r.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"}),r.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"}),r.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!h),r.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!h),r=t.addMenu({title:"table.col"}),r.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"}),r.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"}),r.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})):t.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})}),e.isWebKit&&i.onKeyDown.add(d),e.isGecko&&i.onKeyDown.add(function(e,i){var n,r,s=e.dom;(37==i.keyCode||38==i.keyCode)&&(n=e.selection.getRng(),r=s.getParent(n.startContainer,"table"),r&&e.getBody().firstChild==r&&t(n,r)&&(n=s.createRng(),n.setStartBefore(r),n.setEndBefore(r),e.selection.setRng(n),i.preventDefault()))}),i.onKeyUp.add(p),i.onSetContent.add(p),i.onVisualAid.add(p),i.onPreProcess.add(function(e,t){var i=t.node.lastChild;i&&("BR"==i.nodeName||1==i.childNodes.length&&("BR"==i.firstChild.nodeName||"Â "==i.firstChild.nodeValue))&&i.previousSibling&&"TABLE"==i.previousSibling.nodeName&&e.dom.remove(i)}),p(),i.startContent=i.getContent({format:"raw"})}),s({mceTableSplitCells:function(e){e.split()},mceTableMergeCells:function(e){var t,n,r;r=i.dom.getParent(i.selection.getNode(),"th,td"),r&&(t=r.rowSpan,n=r.colSpan),i.dom.select("td.mceSelected,th.mceSelected").length?e.merge():c.open({url:o+"/merge_cells.htm",width:240+parseInt(i.getLang("table.merge_cells_delta_width",0)),height:110+parseInt(i.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:t,cols:n,onaction:function(t){e.merge(r,t.cols,t.rows)},plugin_url:o})},mceTableInsertRowBefore:function(e){e.insertRow(!0)},mceTableInsertRowAfter:function(e){e.insertRow()},mceTableInsertColBefore:function(e){e.insertCol(!0)},mceTableInsertColAfter:function(e){e.insertCol()},mceTableDeleteCol:function(e){e.deleteCols()},mceTableDeleteRow:function(e){e.deleteRows()},mceTableCutRow:function(e){h=e.cutRows()},mceTableCopyRow:function(e){h=e.copyRows()},mceTablePasteRowBefore:function(e){e.pasteRows(h,!0)},mceTablePasteRowAfter:function(e){e.pasteRows(h)},mceTableDelete:function(e){e.deleteTable()}},function(e,t){i.addCommand(t,function(){var t=a();t&&(e(t),i.execCommand("mceRepaint"),l())})}),s({mceInsertTable:function(e){c.open({url:o+"/table.htm",width:400+parseInt(i.getLang("table.table_delta_width",0)),height:320+parseInt(i.getLang("table.table_delta_height",0)),inline:1},{plugin_url:o,action:e?e.action:0})},mceTableRowProps:function(){c.open({url:o+"/row.htm",width:400+parseInt(i.getLang("table.rowprops_delta_width",0)),height:295+parseInt(i.getLang("table.rowprops_delta_height",0)),inline:1},{plugin_url:o})},mceTableCellProps:function(){c.open({url:o+"/cell.htm",width:400+parseInt(i.getLang("table.cellprops_delta_width",0)),height:295+parseInt(i.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:o})}},function(e,t){i.addCommand(t,function(t,i){e(i)})})}}),e.PluginManager.add("table",e.plugins.TablePlugin)})(tinymce);