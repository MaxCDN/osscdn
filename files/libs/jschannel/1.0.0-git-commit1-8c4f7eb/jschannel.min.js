var Channel=function(){"use strict";function c(a,c,d,e){function f(b){for(var c=0;c<b.length;c++)if(b[c].win===a)return!0;return!1}var g=!1;if("*"===c){for(var h in b)if(b.hasOwnProperty(h)&&"*"!==h&&"object"==typeof b[h][d]&&(g=f(b[h][d])))break}else b["*"]&&b["*"][d]&&(g=f(b["*"][d])),!g&&b[c]&&b[c][d]&&(g=f(b[c][d]));if(g)throw"A channel is already bound to the same window which overlaps with origin '"+c+"' and has scope '"+d+"'";"object"!=typeof b[c]&&(b[c]={}),"object"!=typeof b[c][d]&&(b[c][d]=[]),b[c][d].push({win:a,handler:e})}function d(a,c,d){for(var e=b[c][d],f=0;f<e.length;f++)e[f].win===a&&e.splice(f,1);0===b[c][d].length&&delete b[c][d]}function e(a){return Array.isArray?Array.isArray(a):-1!=a.constructor.toString().indexOf("Array")}var a=Math.floor(1000001*Math.random()),b={},f={},g=function(a){try{var c=JSON.parse(a.data);if("object"!=typeof c||null===c)throw"malformed"}catch(a){return}var g,h,i,d=a.source,e=a.origin;if("string"==typeof c.method){var j=c.method.split("::");2==j.length?(g=j[0],i=j[1]):i=c.method}if("undefined"!=typeof c.id&&(h=c.id),"string"==typeof i){var k=!1;if(b[e]&&b[e][g])for(var l=0;l<b[e][g].length;l++)if(b[e][g][l].win===d){b[e][g][l].handler(e,i,c),k=!0;break}if(!k&&b["*"]&&b["*"][g])for(var l=0;l<b["*"][g].length;l++)if(b["*"][g][l].win===d){b["*"][g][l].handler(e,i,c);break}}else"undefined"!=typeof h&&f[h]&&f[h](e,i,c)};return window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent&&window.attachEvent("onmessage",g),{build:function(b){var g=function(a){if(b.debugOutput&&window.console&&window.console.log){try{"string"!=typeof a&&(a=JSON.stringify(a))}catch(c){}console.log("["+j+"] "+a)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if("object"!=typeof b)throw"Channel build invoked without a proper object argument";if(!b.window||!b.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===b.window)throw"target window is same as present window -- not allowed";var h=!1;if("string"==typeof b.origin){var i;"*"===b.origin?h=!0:null!==(i=b.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))&&(b.origin=i[0].toLowerCase(),h=!0)}if(!h)throw"Channel.build() called with an invalid origin";if("undefined"!=typeof b.scope){if("string"!=typeof b.scope)throw"scope, when specified, must be a string";if(b.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var j=function(){for(var a="",b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}(),k={},l={},m={},n=!1,o=[],p=function(a,b,c){var d=!1,e=!1;return{origin:b,invoke:function(b,d){if(!m[a])throw"attempting to invoke a callback of a nonexistent transaction: "+a;for(var e=!1,f=0;f<c.length;f++)if(b===c[f]){e=!0;break}if(!e)throw"request supports no such callback '"+b+"'";t({id:a,callback:b,params:d})},error:function(b,c){if(e=!0,!m[a])throw"error called for nonexistent message: "+a;delete m[a],t({id:a,error:b,message:c})},complete:function(b){if(e=!0,!m[a])throw"complete called for nonexistent message: "+a;delete m[a],t({id:a,result:b})},delayReturn:function(a){return"boolean"==typeof a&&(d=a===!0),d},completed:function(){return e}}},q=function(a,b,c){return window.setTimeout(function(){if(l[a]){var d="timeout ("+b+"ms) exceeded on method '"+c+"'";l[a].error("timeout_error",d),delete l[a],delete f[a]}},b)},r=function(a,c,d){if("function"==typeof b.gotMessageObserver)try{b.gotMessageObserver(a,d)}catch(h){g("gotMessageObserver() raised an exception: "+h.toString())}if(d.id&&c){if(k[c]){var i=p(d.id,a,d.callbacks?d.callbacks:[]);m[d.id]={};try{if(d.callbacks&&e(d.callbacks)&&d.callbacks.length>0)for(var j=0;j<d.callbacks.length;j++){for(var n=d.callbacks[j],o=d.params,q=n.split("/"),r=0;r<q.length-1;r++){var s=q[r];"object"!=typeof o[s]&&(o[s]={}),o=o[s]}o[q[q.length-1]]=function(){var a=n;return function(b){return i.invoke(a,b)}}()}var t=k[c](i,d.params);i.delayReturn()||i.completed()||i.complete(t)}catch(h){var u="runtime_error",v=null;if("string"==typeof h?v=h:"object"==typeof h&&(h&&e(h)&&2==h.length?(u=h[0],v=h[1]):"string"==typeof h.error&&(u=h.error,h.message?"string"==typeof h.message?v=h.message:h=h.message:v="")),null===v)try{v=JSON.stringify(h),"undefined"==typeof v&&(v=h.toString())}catch(w){v=h.toString()}i.error(u,v)}}}else d.id&&d.callback?l[d.id]&&l[d.id].callbacks&&l[d.id].callbacks[d.callback]?l[d.id].callbacks[d.callback](d.params):g("ignoring invalid callback, id:"+d.id+" ("+d.callback+")"):d.id?l[d.id]?(d.error?l[d.id].error(d.error,d.message):void 0!==d.result?l[d.id].success(d.result):l[d.id].success(),delete l[d.id],delete f[d.id]):g("ignoring invalid response: "+d.id):c&&k[c]&&k[c]({origin:a},d.params)};c(b.window,b.origin,"string"==typeof b.scope?b.scope:"",r);var s=function(a){return"string"==typeof b.scope&&b.scope.length&&(a=[b.scope,a].join("::")),a},t=function(a,c){if(!a)throw"postMessage called with null message";var d=n?"post  ":"queue ";if(g(d+" message: "+JSON.stringify(a)),c||n){if("function"==typeof b.postMessageObserver)try{b.postMessageObserver(b.origin,a)}catch(e){g("postMessageObserver() raised an exception: "+e.toString())}b.window.postMessage(JSON.stringify(a),b.origin)}else o.push(a)},u=function(a,c){if(g("ready msg received"),n)throw"received ready message while in ready state.  help!";for(j+="ping"===c?"-R":"-L",v.unbind("__ready"),n=!0,g("ready msg accepted."),"ping"===c&&v.notify({method:"__ready",params:"pong"});o.length;)t(o.pop());"function"==typeof b.onReady&&b.onReady(v)},v={unbind:function(a){if(k[a]){if(!delete k[a])throw"can't delete method: "+a;return!0}return!1},bind:function(a,b){if(!a||"string"!=typeof a)throw"'method' argument to bind must be string";if(!b||"function"!=typeof b)throw"callback missing from bind params";if(k[a])throw"method '"+a+"' is already bound!";return k[a]=b,this},call:function(b){if(!b)throw"missing arguments to call function";if(!b.method||"string"!=typeof b.method)throw"'method' argument to call must be string";if(!b.success||"function"!=typeof b.success)throw"'success' callback missing from call";var c={},d=[],e=[],g=function(a,b){if(e.indexOf(b)>=0)throw"params cannot be a recursive data structure";if(e.push(b),"object"==typeof b)for(var f in b)if(b.hasOwnProperty(f)){var h=a+(a.length?"/":"")+f;"function"==typeof b[f]?(c[h]=b[f],d.push(h),delete b[f]):"object"==typeof b[f]&&g(h,b[f])}};g("",b.params);var h={id:a,method:s(b.method),params:b.params};d.length&&(h.callbacks=d),b.timeout&&q(a,b.timeout,s(b.method)),l[a]={callbacks:c,error:b.error,success:b.success},f[a]=r,a++,t(h)},notify:function(a){if(!a)throw"missing arguments to notify function";if(!a.method||"string"!=typeof a.method)throw"'method' argument to notify must be string";t({method:s(a.method),params:a.params})},destroy:function(){d(b.window,b.origin,"string"==typeof b.scope?b.scope:""),window.removeEventListener?window.removeEventListener("message",r,!1):window.detachEvent&&window.detachEvent("onmessage",r),n=!1,k={},m={},l={},b.origin=null,o=[],g("channel destroyed"),j=""}};return v.bind("__ready",u),setTimeout(function(){t({method:s("__ready"),params:"ping"},!0)},0),v}}}();